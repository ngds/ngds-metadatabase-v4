<!DOCTYPE html>
<html>
<head>
<title>NGDS Admin</title>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.3/leaflet.draw.css' rel='stylesheet' />
<!--link href='/public/css/ngds.css' rel='stylesheet' /-->
<link rel="stylesheet" href="/css/ngds.css" />
<link rel="stylesheet" href="/css/dds.css" />

<link rel="shortcut icon" href="/img/nico.ico" />

<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.3/leaflet.draw.js'></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/js/ngdsUI.js"></script>
<script src="/js/ngds-admin.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json2html/1.2.0/json2html.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.json2html/1.2.0/jquery.json2html.min.js"></script>
<link href="/css/spin.css" type="text/css" rel="stylesheet" />
<script src="/js/spin.js"></script>
<script>

  var sSrchUrl = "";
	var sPage = 0;
	var sType ="";
  var sOff = 0;
  var pgSize = 25;
  var curID = "";
	var gN = 180,
		  gW = -180,
		  gS = -180,
		  gE = 180;
 var drawnItems;
  var harvestAction='Preview';

    var baseRef="http://132.249.238.169:8080/geoportal/csw?service=CSW&request=GetRecords&f=json&size=20";
    var baseRef="/cinergi?";
    var baseEsri = "http://www.arcgis.com/sharing/rest/search?f=pjson&num=20";
    var sR;

    $(document).ready(function(){
    	 $("#GetPreview").click(function() {
    	 	sPage = 0;
        var og = $("#srcCollection");
        if ( og[0] ) { og = og[0] }
    	 	show_preview(og)
    	 });

    	$("#RunHarvest").click(function() {
    	  var og = $("#srcCollection");
        if ( og[0] ) { og = og[0] }
        var so = og.options[og.selectedIndex].value;
    	 	execHarvest(so);

    	 });

      $("#hsGetInfo").click(function() {
        var og = $("#srcCollection");
        if ( og[0] ) { og = og[0] }
        harvestSourceInfo(og);
       });
      

      $("#HarvestHistory").click(function() {
        show_harvest_history();
       });

		 $(".g-item-save").click(function() {
		 	console.log('www');
    	 	alert('Save Button');
    	 });

		$("#SaveSrch").click(function() {

      if ( sSrchUrl.length > 1 ) {

    			var inp = $("#q").val();
          var inJ = inp.split(" ").join('+');
          var cval = sSrchUrl + "#-#" + inJ;

    			var d = new Date();
    			var cn = 'Search' + d.toUTCString();
        	setCookie(cn,cval,1000);

          seaSet();
    	}
    	 
    });
    $("#RunQ").click(function() {

      var xUrl = $("#seaSel").find(":selected").val();
      sSrchUrl = xUrl;
      var zUrl = xUrl.replace(/-#-/g,'=');
      var zS = zUrl.split('=');
      var ss = zS[zS.length-1];

      $("#q").val(ss.replace(/\+/g,' '));

      show_cinergi(0,zUrl);

    });

    $("#wfCreate").click(function() {
      var inp = $("#wfc").val();
      var d = new Date();
      var cn = 'Project' + d.toUTCString();
        setCookie(cn,inp,1000);
        listWB();
       });


		$("#pagePrev").click(function() {
			if ( sPage > 0) {
				sPage--;
        sOff = sOff - pgSize;
			}
			$("#PageCnt").html("Page " + sPage);
      if ( harvestAction == 'Preview') {
        var og = $("#srcCollection");
        if ( og[0] ) { og = og[0] }
        show_preview(og);
      }

      if ( harvestAction == 'History') {
        show_harvest_history(sPage);
      }

      if ( harvestAction == 'History') {
        show_harvest_history(sPage);
      }

      /*
			if ( sType == "Cinergi" ) {
				show_preview(sPage);
			} else {
				show_harvest(sPage);
      }
      */

    	 	console.log('prev' + sPage);

    	 });

		$("#pageNext").click(function() {
				sPage++;
        sOff = sOff + pgSize;
				$("#PageCnt").html("Page " + sPage);
        if ( harvestAction == 'Preview') {
          var og = $("#srcCollection");
          if ( og[0] ) { og = og[0] }
          show_preview(og);
        }
				if ( sType == "Cinergi" ) {
					show_preview(sPage);
				} else {
					show_harvest(sPage);
				}

    	 	console.log('next' + sPage);
    	 });

		$("#clrWB").click(function() {
    	 	clearCookies();
    	 });

    });

   $('#accordion div').hide();

  $('#wbds').click(function() {
        console.log('thisss')
      });

   $('#accordion p span').click(function(){
       console.log('what');
               //$('#accordion div').slideUp();
               //$(this).parent().next().slideDown();
               //return false;
       });

/*
    $(document).on('click', "button.g-item-save", function () {
    	var id = this.id;
    	console.log(id);
    	var ca = id.split('#-#');
    	if (ca.length > 1) {
        var srID = saveSearch();
        var d = new Date();
        var cn = 'SearRec' + d.toUTCString();
        var cVal = ca[1] +'#-#'+srID;
    		var didI = setCookie(cn,cVal,1000);

        if  ( didI ) {
          $(this).parent().css( "background-color", "#aaaabb" );

        }
    		listWB();
        //saveSearch();
    	}

	});
*/

  function saveSearch() {

     if ( sSrchUrl.length > 1 ) {

          // Check if search exists
          var sF = true;
          var sUrch = sSrchUrl.split('-#-');
          var ursa = sUrch[sUrch.length-1];

          var ca = document.cookie.split(';');
          for(var i = 0; i <ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0)==' ') {
                  c = c.substring(1);
              }
              if ( c.indexOf('Search') == 0 && c.indexOf(ursa) > 0 ) {
                  sF = false;
                  console.log(' save search exists'+ ursa)
                  return sSrchUrl
                  //return c.substring(name.length,c.length);
              }
          }

          if ( sF ) {

            var inp = $("#q").val();
            var inJ = inp.split(" ").join('+');
            var cval = sSrchUrl + "#-#" + inJ;

            var d = new Date();
            var cn = 'Search' + d.toUTCString();
            setCookie(cn,cval,1000);

            seaSet();
            return cval;

          }
         
      }


  }

  var schemaView  = function () {

  }
	/*
  var urlCheck = function( urlString ) {
  // Readl time asynchronous check

    var hurl = '/url_status?' + 'url='+urlString ;
    console.log('start url check');
      $.ajax({
          type: 'GET',
          url: hurl,
          dataType: 'json',
          contentType: "application/json",
          success: function(data, status) {
            if ( data ) {
              console.log('url check - OK');
              //$( 'a[href*="'+lnk+'"]"').class("aref-valid");
              $('a[href*="'+urlString+'"]').attr('class','aref-valid');
              
            } else {
              console.log('url check - BAD');
              $('a[href*="'+urlString+'"]').attr('class','aref-not');
            }
        
          }, 
          error: function (jqXHR, status, err) {  
            console.log('url check error');
            cb('Nope');
          }

      });
  }
*/
// ESRI Section

 
  function coLinks(lnk) {

    for (var d in lnk) {
    //lnk.forEach(function (d) {
      var tlx = lnk[d].href;
      console.log('Found ' + tlx );
      
    }

  }

  function collectInternalLinks($) {
    var allRelativeLinks = [];
    var allAbsoluteLinks = [];

    var relativeLinks = $("a[href^='/']");
    relativeLinks.each(function() {
        allRelativeLinks.push($(this).attr('href'));

    });

    var absoluteLinks = $("a[href^='http']");
    absoluteLinks.each(function() {
        allAbsoluteLinks.push($(this).attr('href'));
    });

    console.log("Found " + allRelativeLinks.length + " relative links");
    console.log("Found " + allAbsoluteLinks.length + " absolute links");
  }





// ************** End ESRI


    function showWB() {
    //

    	$('#workbench').toggle();
    	$('#wbNav').toggle();

		  $("#Lx25").toggle();    	
    	$("#cb").toggle();

    	listWB();
    	
    }

    function showSearch(moi) {
      var nid = moi.id;
      var np = nid.split('-');
      var nSrc = np[1];
      var hid = np[2];

      var gs = getCookie(np[1]);

      var sName = gs.split('=');

       $("#workbench").html('');
       var pstack = '<b>Saved Searches</b></br>';
       var zc= sName[1] + "</br>";

       $("#workbench").append(
          $('<button>')
            .attr('class','action-button')
            .attr('id','abx-'+hid)
            .attr('docid','mdrem-'+hid)
            .attr('onclick','javascript:removeItem(this);').append('Del'),
          $('<button>')
            .attr('class','action-button')
            .attr('id','rb-note-'+hid)
            .attr('docid','rbnote-' + hid)
            .attr('onclick','javascript:annotateItem(this);').append('Annotate'),
          $('<button>')
            .attr('class','action-button')
            .attr('id','pax-'+hid)
            .attr('docid','projadd-' + hid)
            .attr('onclick','javascript:projectItem(this);').append('Add to Project'),
          $('<div>')
          .attr('class', 'g-item-card')
          .append( pstack + zc), 
          $('<div>')
            .attr('id','SrchRec')
            .attr('class', 'g-item-card')
            .append('Saved Records</br>')
              .append('<ul>')
              .attr('id',"ulSrchRec")
              .attr('class',"nav navbar-nav") );

      var ca = document.cookie.split(';');
      var indx = 0;
      var bldLst = "";

      for(var i = 0; i < ca.length; i++) {
            var cRec = ca[i];
            var nx = cRec.split('=');
            indx++;
            console.log(' cookie ' + indx);
            var bldLst = "";

            if (nx[0].indexOf("SearRec" ) != -1 ) {
              var vx=nx[1];
              var vs = vx.split('#-#');
              if  ( vs[0] == nSrc ) {
                var rcd = getCookie(vs[1]);
                var nxVal = rcd.split('#-#');
                console.log(nxVal);
                var napalm = nxVal[2];
                var nSrc = "";
                if ( nxVal[0] == 'ddh') { nSrc = "Cinergi";  } else { nSrc = "ESRI"; }
                indx++;

                $('#ulSrchRec').append(
                  $('<li>').attr('id','lpx-'+indx)
                  .attr('class','wb-li-item')
                  .attr('docid',nx[0].trim())
                  .append(
                      $('<div>').attr('class','div-rb')
                      .attr('id','rbx-'+nSrc + '-' + nx[0].trim())
                      .attr('onclick','javascript:showItem(this);')
                      .append('<b>' + nSrc + ': ' + napalm + '</b>')                       
                  ));
              }
            }
      }

    }

    function showProject(moi) {
      var nid = moi.id;
     // var pid = moi.docid;
      var np = nid.split('-');
      var nSrc = np[1];
      var hid = np[2];

      $("#workbench").html('');
      var pstack = '<b>Project: ' + hid + ' </b></br>';
      var zc="Description</br></br>Related Searches</br></br>";

      $("#workbench").append(
          $('<button>')
            .attr('class','action-button')
            .attr('id','abx-'+hid)
            .attr('docid','mdrem-'+hid)
            .attr('onclick','javascript:removeItem(this);').append('Del'),
          $('<button>')
            .attr('class','action-button')
            .attr('id','rb-note-'+hid)
            .attr('docid','rbnote-' + hid)
            .attr('onclick','javascript:annotateItem(this);').append('Annotate'),
          $('<button>')
            .attr('class','action-button')
            .attr('id','pax-'+hid)
            .attr('docid','projadd-' + hid)
            .attr('onclick','javascript:shareItem(this);').append('Share'),
          $('<div>')
            .attr('class', 'g-item-card')
            .append(pstack),
          $('<div>')
            .attr('id','PrjSearch')
            .attr('class', 'g-item-card')
            .append('Related Searches</br>')
              .append('<ul>')
              .attr('id',"ulPrjSrch")
              .attr('class',"nav navbar-nav"),
          $('<div>')
            .attr('id','PrjRecords')
            .attr('class', 'g-item-card')
            .append('Related Datasets</br>')
            .append('<ul>')
              .attr('id',"ulPrjRec")
              .attr('class',"nav navbar-nav") );


      
      var ca = document.cookie.split(';');
      var indx = 0;
      var bldLst = "";

      for(var i = 0; i < ca.length; i++) {
            var cRec = ca[i];
            var nx = cRec.split('=');
            indx++;
            console.log(' cookie ' + indx);
            var bldLst = "";

            if (nx[0].indexOf("RecProj" ) != -1 ) {
              var vx=nx[1];
              var vs = vx.split('#-#');
              if  ( vs[0] == hid ) {
                var rcd = getCookie(vs[1]);
                var nxVal = rcd.split('#-#');
                console.log(nxVal);
                var napalm = nxVal[2];
                var nSrc = "";
                if ( nxVal[0] == 'ddh') { nSrc = "Cinergi";  } else { nSrc = "ESRI"; }
                indx++;

                $('#ulPrjRec').append(
                  $('<li>').attr('id','lpx-'+indx)
                  .attr('class','wb-li-item')
                  .attr('docid',nx[0].trim())
                  .css({left: 300})
                  .append(
                      $('<div>').attr('class','div-rb')
                      .attr('id','rbx-'+nSrc + '-' + nx[0].trim())
                      .css({left: 300})
                      .attr('onclick','javascript:showItem(this);')
                      .append('<b>' + nSrc + ': ' + napalm + '</b>')                       
                  ));
              }
            }
      }
  
    }

    var lVote = function (bid) {
          //$(bid).css(' background: '#0971B2'); 
        var clx = bid.style.background;
        var vC =  $(bid).html();
        // var clr = $(bid).css('background');
        if ( vC == "Vote" ) {
          $(bid).html("Good");
          $(bid).css('background','#72b802');
        
        }  else if ( vC == "Good" ) {
          $(bid).html("Bad");
          $(bid).css('background','#b97182'); 
        }  else if ( vC == "Bad" ) {
          $(bid).html("Good-NR");
          $(bid).css('background','#a9a172'); 
        }  else if ( vC == "Good-NR" ) {
          $(bid).html("Vote");
          $(bid).css('background','#0971b2'); 
        }  else {
          $(bid).html("Vote");
          $(bid).css('background','#0971B2'); 
        }
    }

    var lNotes = function (bid) {
        var ld = bid.id; 
        var ls = ld.substring(ld.indexOf('-') +1);
        var did = 'ln-'+ls;
        var why = document.getElementById(did);
       
        if ( $(why).is(":visible") ) {
            $(why).hide();   
        } else {
          var dval = "Test Value";
          var editStr = '<b>Edit:</b><input class="text1" name="note" type="text" placeholder="Rate the Link .." value="' + dval + '">';

          $(why).html(editStr);   
          $(why).show();  

        }
        
    }

    var lInspect = function(fid) {
      var ld = fid.id;
      var ls = ld.substring(ld.indexOf('-') +1);


      // First try header check

      var rip = "/url_header?url=" + ls;
        $.ajax({
          type: 'GET',
          url: rip,
          dataType: "json",
          contentType: "application/json",
          success: function(data) {

              if ( data == "ERROR") {
                $(ld).css('background','#b27102');
                console.log('err');
              } else {
                var sCode = data.statusCode;
                var hdr = data.headers;
                var rsp = data.request;

                var csize = hdr["content-length"];
                var ctype = hdr["content-type"];
                var href = rsp.uri.href;
                var bg = '#aaaaaa';
                if (sCode) {
                    if (sCode == "400" || sCode == "401" || sCode == "402" ||sCode == "404" || sCode == "403" ) { bg = "#bb8840" }
                    if (sCode == "301" || sCode == "302" || sCode == "302" ) { bg = "#ff6600" }
                    if (sCode == "200" || sCode == "201" || sCode == "203" ) { bg = "#44bb22" }

                }
                $(fid).css('background',bg);
                $(fid).html(ctype);
                console.log('Header Check ' + sCode + ' ' + ctype + ' ' + csize + ' ' + href);
                
              }

              
          },
          error: function(err) {
            console.log('err');
              $(ld).css('background','#b27102');            
          }
        });


    }

    function showItem(moi) {

      var nid = moi.id;
      var np = nid.split('-');
      var nSrc = np[1];
      var nId = np[2];
      curID = nId;

       $("#workbench").html('');

      if ( nSrc == 'Cinergi' ) {
        var rip = "/cin1rec?id=" + nId;
        $.ajax({
          type: 'GET',
          url: rip,
          dataType: "json",
          contentType: "application/json",
          success: function(data) {
             
              var pd = data._source;
              var pstack = '<b>Cinergi Record: ';

              //var ha = pd.results;
               var zc = '</br>';

              //for (i = 0; i < ha.length; i++) {
                //var hid = pd.apiso_Identifier_s;
                var hid = data._id; 

                var src_name = 'Data Source: ' + pd.apiso_Abstract_txt;
                var src_type = 'Data Source Type: ' + pd.src_source_type_s;
                
                pstack = pstack + pd.title + '</b>';

                var src_title = pd.title;
                var src_desc = 'Abstract: ' + pd.apiso_Abstract_txt;
                var zed = urlCheck(pd.src_uri_s);

                var src_uri = 'source URI: ' + '<a  class="aref-valid" rel="external" target ="_blank" href="' + pd.src_uri_s + '">' + pd.src_uri_s + '</a></br>' ;
                var scrape_uri = 'Scrape: ' + '<a onclick=javascript:tryme("' + pd.src_uri_s + '")>getJSON</a></br>' ;

              var lnk = pd.links_s;
              var sl = '<b>Links</b></br>';

              if (Array.isArray(lnk) ) {
                for (z= 0; z <lnk.length; z++) {
                  var ls = lnk[z];
                  var zed = urlCheck(ls);
                  var lbVote = '<a class="vote-button" id="vote'+ls+'" onclick="javascript:lVote(this);" >Vote</a>';
                  var lbInspect = '<a class="link-button" id="inspect-'+ls+'" onclick="javascript:lInspect(this);" >Inspect</a>';
                  var lbNote = '<a class="link-button" id="note-'+ls+'" onclick="javascript:lNotes(this);">Notes</a>';
                  var alnk = '<a rel="external" class="aref-valid" target ="_blank" onclick="javascript:lbak(this);" href="' + ls + '">' + ls + '</a>';
                  var cDiv = '<div id="ln-'+ls+'" style="display:none;"></div>';
                  sl = sl + lbVote + lbInspect + lbNote + alnk + cDiv + '</br>';

                }
                console.log(sl);
              } else {
                if ( typeof(lnk) !== "undefined") {
                  var zed = urlCheck(ls);                  
                  sl = sl + '<a rel="external" class="aref-valid" target ="_blank" onclick="javascript:lbak(this);" href="' + lnk + '">' + lnk + '</a></br>';
                }
              }

              zc = zc +  "</br> " + src_type + '</br>' + src_uri + '</br>' + src_desc + '</br>' + sl + '</br>';

              $("#workbench").append(
                $('<button>')
                  .attr('class','action-button')
                  .attr('id','abx-'+hid)
                  .attr('docid','mdrem-'+hid)
                  .attr('onclick','javascript:removeItem(this);').append('Del'),
                $('<a>')
                 .attr('class','action-button')
                 .attr('href','http://mdeditor.usgin.org/?docId='+hid)
                  .attr('target','_blank')
                  .append('Metadata Editor'),
                $('<button>')
                  .attr('class','action-button')
                  .attr('id','dsv-'+hid)
                  .attr('docid','dsv-' + hid)
                  .attr('onclick','javascript:lVote(this);').append('Vote'),
                $('<button>')
                  .attr('class','action-button')
                  .attr('id','rbnote-'+hid)
                  .attr('docid','rbnote-' + hid)
                  .attr('onclick','javascript:editItem(this);').append('Annotate'),
                $('<button>')
                  .attr('class','action-button')
                  .attr('id','pax-'+hid)
                  .attr('docid','projadd-' + hid)
                  .attr('onclick','javascript:item2project(this);').append('Add to Project'),
                $('<div>')
                  .attr('id','dshn-'+hid)
                  .attr('style','display:none'),
                $('<div>')
                .attr('class', 'g-item-card')
                .append( pstack + zc)
                );
          }
        });


        console.log(moi.id);
      } else {
        // ESRI record


      }
    }

    function item2project(itm) {
        var nid = itm.id.split('-');
        var iid = nid[1];

        var ndiv = 'dshn-'+iid;
        var why = document.getElementById(ndiv);
      
         if ( $(why).is(":visible") ) {
            $(why).hide();   
          } else {

            // Build the project select list

            var ca = document.cookie.split(';');
            var indx = 0;

            var selStr = '<select id="prjSel" >';

            for(var i = 0; i < ca.length; i++) {
                  var cRec = ca[i];
                  var nx = cRec.split('=');
                  indx++;
                  console.log(' cookie ' + indx);
                  
                  if (nx[0].indexOf("Project") != -1 ) {
                    selStr = selStr + '<option value="'+nx[0]+'">'+nx[1] + '</option>';
                  }
            }

            var selStr = selStr + '</select><button class="action-button" id="svp-'+ iid + '" onclick=javascript:savePR(this); >Save</button>';
            $(why).html(selStr);
            $(why).show();   
          
          }

    
    }

    function savePR(pb) {

        var nid = pb.id.split('-');
        var recid = nid[1];

        var ndiv = 'dshn-'+recid;
        var why = document.getElementById(ndiv);

        var projID = $("#prjSel").find(":selected").val();
        // set a cookie and exit

        var d = new Date();
        var cn = "RecProj" + d.toUTCString();

        var cVal = projID + '#-#' + curID;
        setCookie(cn,cVal,1000);
            
         $(why).hide();

    }


    function editItem(md) {
      console.log('ui');
      
      var nid = md.id.split('-');
      var iid = nid[1];

      var ndiv = 'dshn-'+iid;
      var why = document.getElementById(ndiv);
     
      if ( $(why).is(":visible") ) {
        $(why).hide();   
      } else {

         var dval = "Test Value";
         var editStr = '<b>Edit:</b><input class="text1" name="note" type="text" placeholder="Rate the Link .." value="' + dval + '">';

         $(why).html(editStr);   
         $(why).show();   
        
      }
     

        /*
      var la = md.attributes[2].value;
      var ls = la.split('-');
      var lnk = 'http://mdeditor.usgin.org/?docId='+ls[1];
      var w = window.open();
      $(w.document.body).html(lnk);
      */

    }


    function clearRightPanel(mol) {
       $("#workbench").html('');
    }

    function toggleSaved(kix) {

      // $('#wbSaved').hide();
      // $('#wbSrch').hide();
     //  $('#prjRecords').hide();

      if ( kix.id == "showSD") {
         $('#wbSaved').toggle();
      }
      if ( kix.id == "showSS") {
        $('#SrchRec').toggle();
      }
      if ( kix.id == "showPR") {
         $('#prjRecords').toggle();
      }

    }

    function listWB() {

    	$('#wbCart').empty();
      $('#wbSrch').empty();  
    	$('#wbProject').empty();

    	var ca = document.cookie.split(';');
    	var indx = 0;

      	for(var i = 0; i < ca.length; i++) {
          	var cRec = ca[i];
          	var nx = cRec.split('=');
          	indx++;
          	console.log(' cookie ' + indx);

            if (nx[0].indexOf("Project") != -1 ) {
    				  $('#wbProject').append(
    					 $('<li>').attr('id','lix-'+indx)
    					   .attr('class','wb-li-item')
    					   .attr('docid',nx[0].trim())
    					   .append($('<div>').attr('class','div-rb')
                                  .attr('id','rb-'+nSrc + '-' + nx[0].trim())
                                  .attr('onclick','javascript:showProject(this);')
                                  .append('<b>' +nx[1] + '</b>') 
                )
                );           		

          	} else if (nx[0].indexOf("Search") != -1 ) {
               var xVal = nx[1].split('#-#');
               var nxVal = xVal[1].replace(/-#-/g,'=');

                $('#wbSrch').append(
                  $('<li>').attr('id','lix-'+indx)
                      .attr('class','wb-li-item')
                      .attr('docid',nx[0].trim())
                      .append($('<div>').attr('class','div-rb')
                            .attr('id','si-' + nx[0].trim())
                            .attr('onclick','javascript:showSearch(this);')
                            .append('<b>' +nxVal + '</b>')                        
                      )
                    ); 
            } else {

          		var nxVal = nx[1].split('#-#');
              console.log(nxVal);
          		var napalm = nxVal[2];
          		var nSrc = "";
          		if ( nxVal[0] == 'ddh') { nSrc = "Cinergi";  } else { nSrc = "ESRI"; }
          		indx++;

          		$('#wbCart').append(
	            	$('<li>').attr('id','lix-'+indx)
	            	.attr('class','wb-li-item')
                   	.attr('docid',nx[0].trim())
                   	.append(
                $('<div>').attr('class','div-rb')
                          .attr('id','rb-'+nSrc + '-' + nx[0].trim())
                          .attr('onclick','javascript:showItem(this);')
                          .append('<b>' + nSrc + ': ' + napalm + '</b>')                       
                ));     
          }
        }
    }

    function getCookie(cname) {
	    var name = cname + "=";
	    var ca = document.cookie.split(';');
	    for(var i = 0; i <ca.length; i++) {
	        var c = ca[i];
	        while (c.charAt(0)==' ') {
	            c = c.substring(1);
	        }
	        if (c.indexOf(name) == 0) {
	            return c.substring(name.length,c.length);
	        }
	    }
	    return "";
	}

    function setCookie(cname, cvalue, exdays) {
	    var d = new Date();
	    d.setTime(d.getTime() + (exdays*24*60*60*1000));
	    var expires = "expires="+d.toUTCString();
	  
	    if ( cname == "Project" ) {
	    	document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        return true;
	    } else {
	    	var coCheck = getCookie(cname);
	    	if ( typeof(coCheck) == "undefined" || coCheck.length == 0 ) {
	        	document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            return true;
	     	} else {
	      		alert('Already saved this one');
            return false
	     	}
	     	
	    }
	     
	}

	function clearCookies() {
	      var ca = document.cookie.split(';');
	      for(var i = 0; i <ca.length; i++) { 
	          var nx = ca[i].split('=');
	          removeItem(nx[0]);
	         
	      }
	      listWB();
	}


	function removeItem( sKey ) {
	   
	    if ( typeof(sKey) == "object" ) {

	      var nk = sKey.attributes['docid'].value;
        var nko = nk.split('-');
        var cid = nko[1];

        var mc = getCookie(cid);
        if ( mc.length > 0 ) {
            document.cookie = cid + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT";  
            clearRightPanel();
            listWB();
        } else {
          console.log('cant find me ' + cid);
        }
	      //document.cookie = cid + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
	      //var undo = '#' + cid; //sKey.id;
	      //$(undo).remove();
       


	    } else {

	       document.cookie = sKey + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
         clearRightPanel();
         listWB();

	    }
	 

	}


  function seaSet() {


     $('#seaSel')
    .find('option')
    .remove()
    .end();

    var ca = document.cookie.split(';');
   
    for(var i = 0; i < ca.length; i++) {
        var cRec = ca[i];
        var nx = cRec.split('=');
       
        if (nx[0].indexOf("Search") != -1 ) {
          var vx = nx[1].split('#-#');
          $('#seaSel').append($('<option/>', { 
              value: vx[0],
              text : vx[1] 
          }));
        }
    }
  }


  var appInit = function() {
    //showCategories(10);
    //initFlic();
    var z = {};
    harvestView();

    //findRecords(z);

  } 

	var initFlic = function()	 {


		  var eb = Number(-80.0);
      var wb = Number(-110.0);
      var nb = Number(45.0);
      var sb = Number(28.0);

      var nbx = nb+0.2*nb;
    	var sbx = sb-0.2*sb;
      var ebx = eb-0.2*eb;
    	var wbx = wb+0.2*wb;


      var initExtent = L.latLngBounds([nbx, wbx], [sbx , ebx]);
	    var rectExtent = L.latLngBounds([nb, wb], [sb , eb]);
        var center = new L.LatLng(sbx + (nbx - sbx)/2 ,ebx + (wbx - ebx)/2);

		 $("#showMap").show(); 
		 //var drawnItems,
		 var 	 drawControl;

		 L.mapbox.accessToken = 'pk.eyJ1IjoiZ2FyeWh1ZG1hbiIsImEiOiJjaW14dnV2ZzAwM2s5dXJrazlka2Q2djhjIn0.NOrl8g_NpUG0TEa6SD-MhQ';
	        map = L.mapbox.map('showMap', 'mapbox.streets', 
                {   infoControl: false,
                    legendControl: false,
                    zoomControl: false, 
                    trackResize: true,
                    opacity: .50,
                    tileSize: 128,  
                    animate: false })
                .setView(center, 6)
                .on('ready',function() { 
                    setTimeout(function(){ 
                        map.invalidateSize();
                        //map.fitBounds(initExtent);
                        //drawnItems = L.rectangle(rectExtent, {color: "#ff7800", weight: 4});
                        //drawnItems.addTo(map);
                        //L.rectangle(rectExtent, {color: "#ff7800", weight: 1}).addTo(map);
                        drawnItems = L.featureGroup().addTo(map);

                        map.addLayer(drawnItems);
                       // drawnItems.setZIndex(99);
                       map.fitBounds(rectExtent);

		                drawControl = new L.Control.Draw({
	                        edit: {
	                            featureGroup: drawnItems
	                        },
	                        draw: {
	                            polygon: false,
	                            polyline: false,
	                            rectangle: true,
	                            circle: false,
	                            marker: false
	                          }
	                    });

		                map.addControl(drawControl);
		                map.on('draw:created', showRectArea);
		                map.on('draw:edited', showRectEdited);
                       

                    }, 200);
                    //MapReady =1;
                    console.log('ready map')})
                .on('resize',function() { console.log('resize map')});

        
                function showRectEdited(e) {
                  e.layers.eachLayer(function(layer) {
                    showRectArea({ layer: layer });
                  });
                }
                function showRectArea(e) {
                  drawnItems.clearLayers();
                  drawnItems.addLayer(e.layer);
                  sR = e.layer.getLatLngs();
                  gN = sR[1].lat;
                  gW = sR[0].lng;
                  gE = sR[2].lng;
                  gS = sR[0].lat;

                }

     //seaSet();

	}

</script>

</head>
<body  onload="appInit()">

    <div class="g-app" id="app">
    <nav class="navbar navbar-inverse">
    <!-- <div class="navbar-header"><a class="navbar-brand" href="#">Cinergi</a></div>-->
	  <ul class="nav navbar-nav">
		<li class="nav-item">
		  <img src="/img/ngds-logo.png" height="48px">
		</li>
		  <li class="nav-item" style="display: inline-block; margin: 2px; float: left; width: 200px">
         <span class="nav-link" style="color: #ffffff;">Manager</span>
      </li>
      <!--li class="nav-item">
        <a class="nav-link" href="#searchPanel" onclick="searchData();" >Search</a>
      </li-->

      <li class="nav-item">
        <a class="nav-link" href="#harvest" onclick="harvestView();" >Harvest</a>
      </li>


      <!--li class="nav-item">
        <a class="nav-link" href="/schema" onclick="schemaView();" >Schemas</a>
      </li-->


      <li class="nav-item">
        <a class="nav-link" href="/schema" onclick="collectionView();" >Collections</a>
      </li>


      <!--li class="nav-item">
        <a class="nav-link" href="#edit" onclick="mdEditor();" >Edit</a>
      </li-->

     <li class="nav-item">
        <a class="nav-link" href="#edit" onclick="processView();" >Automate</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-link" href="#edit" onclick="helpView();" >Help</a>
    </li>
       
	    <!--li class="nav-item">
	      <a class="nav-link" href="#searchPanel" onclick="remoteCSW();" >Map</a>
	    </li-->

      <!--div style="display: inline-block; float: right !important;">
        <li class="nav-item" style="display: inline-block;  float: right">
          <a class="nav-link" href="#workbenchPanel" onclick="showWB();" >Help</a>
        </li>
    </div-->
	  </ul> 

	</nav>
	</div>

	<div id="leftHarvest" class="g-search-pane-left" >
    <span class="dijitTitlePaneTextNode">Harvest Source</span></br>
    <select id="srcCollection" onchange="harvestSourceInfo(this)" style="width:250px;"  >
     <!--option value="http://catalog.usgin.org/geothermal/csw">USGIN</option-->
    </select>
    <button class="action-button" id="hsGetInfo" >Info</button></br>
    <div style="border:1px solid silver; margin: 2px; border-radius: 4px;">
    		 <button class="action-button" id="GetPreview" >Remote Preview</button></br>
         <input type="radio" name="pFilter" value="latest" checked>By Date<br>
         <input type="radio" name="pFilter" value="since">Since Last Harvest<br>
         <input type="radio" name="pFilter" value="query">Search By Query<br>
         <input type="text" id="preQuery" size="25px"><br>
        <button class="arrow-button" id="pagePrev" > < </button>
        <span id="PageCnt">Page 0</span>
        <button class="arrow-button" id="pageNext" > > </button></br>
    </div>
    <button class="action-button" id="HarvestHistory" >Source History</button></br>
    <div style="border:1px solid silver; margin: 2px; border-radius: 4px;">
      <button class="action-button" id="RunHarvest" >Run Harvest</button></br>
      <input type="radio" name="hType" value="selection" checked>On Selection<br>
      <input type="radio" name="hType" value="full">Full Source Collection<br>
      <span>Process Options</span></br>
       <input type="radio" name="hProcOpt" value="all" checked>Overwrite All<br>
       <input type="radio" name="hProcOpt" value="newer">Overwrite New<br>
       <input type="radio" name="hProcOpt" value="newer">Reconcile<br>
      <button class="action-button" id="HarvestClear" onclick="harvestClear()" >Clear</button></br>
      <button class="action-button" id="HarvestSchedule" onclick="harvestSchedule()" >Schedule</button></br>
    </div>
    <button class="action-button" id="HarvestNew" onclick="harvestNewSource()" >Create New Source</button></br>
    <button class="action-button" id="HarvestAdmin" >Configure</button></br>
   
  </div>

  <div id="leftProcess" class="g-search-pane-left" style="display: none;">
    <span class="dijitTitlePaneTextNode">Process Definition </span></br>
    <select id="srcProcess" onchange="pdView(this)" style="padding=20px; width:250px;"  >
     <option value="1">standard harvest</option>
    </select></p>
    <button class="action-button" id="GetProcess" >Edit</button></br>
    <button class="action-button" id="ProcessHistory" >View History</button></br>
    <button class="action-button" id="execProcess" >Run on Collection</button></br>
  
    <button class="action-button" id="ProcessNew" onclick="processNew()" >Create New Process</button></br>
    <button class="action-button" id="HarvestAdmin" >Configure</button></br>
   
  </div>
  <div id="leftSearch" class="g-search-pane-left" style="margin:5px; display:none" >
    <!--span class="dijitTitlePaneTextNode">NGDS Search</span-->
    <input type="text" class="form-control" style="height:30px;" id="gSearchBox" placeholder="Enter Search terms" size="36" />
    <button id="searchBtn" class="arrow-button" onclick="findRecords(this)">Search</button></br>
    <div style="height:400px">
      <span class="dijitTitlePaneTextNode">Location</span></br>
    <!--button class="arrow-button" id="clrRecords" onclick="clearRightPanel(this);" >Clear</button></br>
    <button class="arrow-button" id="showSD" onclick="toggleSaved(this);" >Saved Datasets</button></br-->
      <div id="showMap" style="height:240px"></div>
    </div>
    <div>
      <span class="dijitTitlePaneTextNode">Categories</span></br>
      <div id="CatList"></div>
    </div>
    <div>
      <span class="dijitTitlePaneTextNode">Data Types</span></br>
      <div id="dtList"></div>
    </div>

  </div> 

  <!--div id="wbSaved" style="display:none">
    <ul id="wbCart" class="nav navbar-nav"></ul>     
    <button class="arrow-button" id="showSS" onclick="toggleSaved(this);" >Saved Searches</button></br>
    <div id="SrchRec" style="display:none">
        <ul id="wbSrch" class="nav navbar-nav">
        </ul>
      </div>
      <span class="dijitTitlePaneTextNode">Bookmark</span></br>
   <button class="arrow-button" id="showPR" onclick="toggleSaved(this);" >Projects</button></br>
    <div id="prjRecords" style="display:none">
        <button class="action-button" id="wfCreate" >New</button><input id="wfc" name="wfc" >
        <ul id="wbProject" class="nav navbar-nav">
        </u>
      </div>
    </div>  
	</div-->

  <div id="cb" class="g-search-pane-right" style="margin:5px;">
       <span id="cb-title" style="margin:5px;">NGDS Harvest Manager</span>
       <div id="rec-results" style="background-color: white; margin:5px;" ></div>
  </div>

  <!--div id="proc" class="g-search-pane-right" style="display: none; margin:5px;">
       <span id="proc-title" style="margin:5px;">Process Manager</span>
       <div id="proc-results" style="background-color: white; margin:5px;" ></div>
  </div>

	<div id="workbench" class="g-search-pane-right" style="display: none;">
	
    <table>
    <tr><td>
      <div id="wbPrSrch"></div>

    </td><td>
       <div id="wbPrData"></div>    
    </td>
    <td>
       <div id="wbPrProc"></div>   
    </td>
    </table>
	</div-->

  <div id="widget-box" class="g-search-pane-right" style="display: none;">
       <span id="widget-title" class="dijitTitlePaneTextNode">Datasets/Citation </span>
       <button id="goSearchBtn" class="arrow-button" onclick="bactoSearch(this)">Return to Search</button></br>
       <div id="widget-view"></div>
  </div>



</body>
</html>

